name: Build

on:
  pull_request: {}

jobs:
  build:
    runs-on: ubuntu-24.04
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - name: setup Crossplane cli
        uses: crossplane-contrib/setup-crossplane-action@cb8aac3f1246b19f101e7f85fd0a38623b4d5ad3 # v0.1.1

      - name: setup go-jsonnet
        uses: zendesk/setup-jsonnet@74119dac8a540c99167a65f14aa1ee99ff143ec2 # v16
        with:
          version: v0.20.0

      - name: setup jrsonnet
        uses: grafana/shared-workflows/actions/setup-jrsonnet@49fd211b0975ce64aa4a37b711746889e55820a8

      - name: Build xpkg
        run: "make -B build"
        shell: bash

      - name: Check if file changed
        id: changed
        uses: tj-actions/verify-changed-files@a1c6acee9df209257a246f2cc6ae8cb6581c1edf # v20.0.4
        with:
          files: |
            !bin

      - name: No files changed
        if: "${{ steps.changed.outputs.files_changed == 'true' }}"
        run: "echo 'Please run `make build`' && exit 1"
        env:
          CHANGED_FILES: "${{ steps.changed.outputs.changed_files }}"
